<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essences Search</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px 0; }
    .controls { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
    .row { display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center; }
    input, select { width: 100%; font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #e6e6e6; padding: 8px; vertical-align: top; }
    th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .meta { color: #666; font-size: 12px; margin-top: 8px; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; color: #444; }
  </style>
</head>
<body>
  <h1>Essences v0 â€” quick search/filter</h1>

  <div class="controls">
    <div class="row">
      <div class="pill">Search</div>
      <input id="q" placeholder="Type anything (matches any column)..." autocomplete="off" />
    </div>

    <div class="row">
      <div class="pill">Column</div>
      <select id="col">
        <option value="__any__">Any column</option>
      </select>
    </div>

    <div class="row">
      <div class="pill">Filter</div>
      <input id="colFilter" placeholder="Optional column-only filter..." autocomplete="off" />
    </div>
  </div>

  <table id="tbl">
    <thead><tr id="hdr"></tr></thead>
    <tbody id="body"></tbody>
  </table>

  <div class="meta" id="meta"></div>

<script>
const state = { data: [], cols: [], q: "", col: "__any__", colFilter: "" };

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function render() {
  const q = state.q.trim().toLowerCase();
  const cf = state.colFilter.trim().toLowerCase();
  const col = state.col;

  const rows = state.data.filter(r => {
    // global query
    let okQ = true;
    if (q) {
      if (col === "__any__") {
        okQ = state.cols.some(c => String(r[c] ?? "").toLowerCase().includes(q));
      } else {
        okQ = String(r[col] ?? "").toLowerCase().includes(q);
      }
    }

    // column filter (always applies to selected column unless Any is chosen)
    let okCF = true;
    if (cf) {
      if (col === "__any__") {
        // if "Any", apply to any column too
        okCF = state.cols.some(c => String(r[c] ?? "").toLowerCase().includes(cf));
      } else {
        okCF = String(r[col] ?? "").toLowerCase().includes(cf);
      }
    }
    return okQ && okCF;
  });

  // table header
  const hdr = document.getElementById("hdr");
  hdr.innerHTML = state.cols.map(c => `<th>${escapeHtml(c)}</th>`).join("");

  // table body
  const body = document.getElementById("body");
  body.innerHTML = rows.map(r => {
    const tds = state.cols.map(c => `<td>${escapeHtml(r[c] ?? "")}</td>`).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  document.getElementById("meta").textContent =
    `${rows.length.toLocaleString()} of ${state.data.length.toLocaleString()} rows`;
}

async function main() {
  const res = await fetch("./essences_data.json", { cache: "no-store" });
  state.data = await res.json();
  state.cols = Object.keys(state.data[0] || {});
  // populate column dropdown
  const sel = document.getElementById("col");
  state.cols.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });

  // wire controls
  document.getElementById("q").addEventListener("input", e => { state.q = e.target.value; render(); });
  document.getElementById("col").addEventListener("change", e => { state.col = e.target.value; render(); });
  document.getElementById("colFilter").addEventListener("input", e => { state.colFilter = e.target.value; render(); });

  render();
}

main().catch(err => {
  document.getElementById("meta").textContent = "Failed to load data: " + err;
});
</script>
</body>
</html>
